' Gambas class file

Public ObjectKey As Label
Public ObjectValue As TextBox
Public textarea1 As Textarea
Public newenvironment As New String[]
Public previewprocess1 As Process
Public previewprocess2 As Process

Public Sub Form_Open()
  Dim key As String
  Dim s As String
  Try Kill "/tmp/font.txt"
  For Each s In Fonts
    ComboBox1.add(s)
  Next
  
  ColorButton2.color = color.Foreground
  ColorButton2.color = color.TextBackground
  ComboBox1.text = panelfont.Font.name
  SpinBox1.Value = panelfont.Font.Size
  
  Me.MAXIMIZED = True
  vbox1.w = optionsbox.Font.TextWidth("INFINALITY_FT_AUTOHINT_HORIZONTAL_STEM_DARKEN_STRENGTH") * 1.1
  For Each key In Application.Env
    If key Like "INFINALITY*" Then
      ObjectKey = New Label(optionsbox)
      ObjectKey.AutoResize = True
      ObjectKey.text = key
      ObjectValue = New Textbox(optionsbox) As "ObjectValue"
      ObjectValue.h = ObjectValue.Font.TextHeight("|") * 1.5
      Object.Lock(Objectvalue)
      ObjectValue.text = Application.Env[key]
      Object.unLock(Objectvalue)
      ObjectValue.tag = key
    Endif
  Next
  GetPreview()
End

Public Sub ObjectValue_Change()
  object.Lock(Last)
  Wait 0.5
  Object.Unlock(Last)
  ApplyEnvironment()
  GetPreview()
End


Public Sub ApplyEnvironment()
  Dim mykey As Object
  newenvironment.clear
  For Each mykey In optionsbox.Children
    If mykey Is Textbox Then
      newenvironment.add(mykey.tag & "=" & mykey.text)
    Endif
  Next
End


Public Sub Button1_Click()
  ApplyEnvironment()
  Try Shell "konsole || lxterminal || gnome-terminal || xfce4-terminal || xterm" With newenvironment
End


Public Sub TextBox1_Activate()
  ApplyEnvironment()
  Try Shell TextBox1.text With newenvironment
  
End


Private previewing As Boolean = False
Private CurrentP As Integer = 0
Public Sub GetPreview()
  If previewing Then Return
  previewing = True
  Try Kill "/tmp/ftpreviewtext.txt"
  Try Kill "/tmp/preview.gbs"
  File.Save("/tmp/ftpreviewtext.txt", TextArea2.text)
  Try Copy "preview.gbs" To "/tmp/preview.gbs"

  If CurrentP = 1 Then
    previewprocess2 = Shell "gbs3 /tmp/preview.gbs " & ColorButton1.color & " " & ColorButton2.color & " 2>/dev/null " With newenvironment For Input As "previewprocess2"
      Else
    previewprocess1 = Shell "gbs3 /tmp/preview.gbs " & ColorButton1.color & " " & ColorButton2.color & " 2>/dev/null " With newenvironment For Input As "previewprocess1"  
  Endif
End


Public Sub previewprocess1_read()
  Dim sLine As String
  Dim win As DesktopWindow
  Dim timeout As Integer = 25
  Read #Last, sLine, -256
  sline = (CInt(Trim(sLine)))
  embedder1.Discard()
  Repeat
   Embedder1.embed(sline)
   Wait 0.1
   timeout -= 1
  Until (embedder1.client <> 0) Or timeout = 0
  Embedder2.hide
  Try previewprocess2.Kill
  Embedder1.show
  CurrentP = 1
  previewing = False
 End

Public Sub previewprocess2_read()
  Dim sLine As String
  Dim win As DesktopWindow
  Dim timeout As Integer = 25
  Read #Last, sLine, -256
  sline = (CInt(Trim(sLine)))
  embedder2.Discard()
  Repeat
   Embedder2.embed(sline)
   Wait 0.1
   timeout -= 1
  Until (embedder2.client <> 0) Or timeout = 0
  Embedder1.hide
  Try previewprocess1.Kill
  Embedder2.Show
  CurrentP = 2
  previewing = False
 End

Public Sub Form_Close()
  Try previewprocess1.Kill
  Try previewprocess2.Kill
End

Public Sub fontchange_Change()
  If Not FMain.visible Then Return
  object.Lock(Last)
  Wait 0.5
  object.Unlock(Last)
  UpdateFont()
End

Public Sub fontchange_Click() 
  If Not FMain.visible Then Return
  UpdateFont()
End

Public Sub UpdateFont()
    Try Kill "/tmp/font.txt"
    TextArea2.Foreground = ColorButton1.color
    TextArea2.background = ColorButton2.color
    panelfont.Font.name = ComboBox1.text
    panelfont.Font.bold = btnBold.Value
    panelfont.Font.Italic = btnItalic.value
    panelfont.Font.Underline bold = btnUnderline.value
    panelfont.Font.size = SpinBox1.value
    panelfont.Font.Strikeout = btnStrikeOut.value
    TextArea2.font = Font[panelfont.Font.ToString()]
    File.save("/tmp/font.txt", panelfont.Font.ToString())
    GetPreview()
End

Public Sub Button2_Click()
  Dim item As String
  Dim env As String
  ApplyEnvironment()
  For Each item In newenvironment
    item = Replace(item, "=", "=\"") & "\""
    env &= item & "\n"
  Next 'item
  Clipboard.Copy(env, "text/plain")
End

Public Sub TextArea2_Change()
  object.Lock(Last)
  Wait 0.5
  object.Unlock(Last)
  GetPreview()
End

Private PreviousLayout As Integer[]
Public Sub ToggleButton1_Click()
Panel2.visible = Not (ToggleButton1.value)

End

Public Sub Button3_Click()

  TextBox1_Activate()

End
